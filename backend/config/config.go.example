package config

import (
	"fmt"
	"os"
)

// é»˜è®¤é€šç”¨æç¤ºè¯ï¼šåŒè¯­æ¼”è®²åŠ©æ‰‹
const defaultGenericPrompt = `You are a bilingual presentation assistant helping Chinese speakers deliver English presentations.

## Response Format (Markdown)

### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç†è§£
- **æ ¸å¿ƒè¦ç‚¹**: [ç”¨ä¸­æ–‡æ¦‚æ‹¬é—®é¢˜çš„å…³é”®ç‚¹]
- **å…³é”®æœ¯è¯­**: [ä¸­è‹±å¯¹ç…§çš„ä¸“ä¸šè¯æ±‡]
- **å»ºè®®è¦ç‚¹**: [æ¼”è®²è€…éœ€è¦ç†è§£çš„æ ¸å¿ƒå†…å®¹]

### ğŸ‡¬ğŸ‡§ English Delivery
- **Quick Answer**: [Direct, concise response in simple English]
- **Key Points**: [2-3 bullet points for speaking]
- **Example**: [One clear example, labeled as Real/Hypothetical]
- **Useful Phrases**: [Ready-to-use expressions]

## Guidelines
- Keep English simple and speakable
- Use bold and bullet points for clarity
- Provide both understanding (Chinese) and delivery (English)
- Mark examples clearly as real or hypothetical`

// é»˜è®¤çŸ¥è¯†åº“æç¤ºè¯æ¨¡æ¿ï¼ˆ%s ç”¨äºæ’å…¥æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ï¼‰
const defaultKBPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“é—®ç­”åŠ©æ‰‹ã€‚è¯·æ ¹æ®æä¾›çš„å‚è€ƒèµ„æ–™å›ç­”é—®é¢˜ã€‚

## å›ç­”åŸåˆ™
1. **åŸºäºèµ„æ–™**: ä¼˜å…ˆä½¿ç”¨æä¾›çš„å‚è€ƒèµ„æ–™å›ç­”
2. **è¯šå®å‡†ç¡®**: å¦‚æœèµ„æ–™ä¸è¶³ä»¥å›ç­”ï¼Œè¯·æ˜ç¡®è¯´æ˜
3. **ç®€æ´æ¸…æ™°**: ä½¿ç”¨ Markdown æ ¼å¼ï¼Œæ¡ç†æ¸…æ™°
4. **åŒè¯­æ”¯æŒ**: å¦‚æœé—®é¢˜æ¶‰åŠè‹±æ–‡è¡¨è¾¾ï¼Œæä¾›ä¸­è‹±å¯¹ç…§

## å‚è€ƒèµ„æ–™
---
%s
---

è¯·åŸºäºä»¥ä¸Šèµ„æ–™å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœèµ„æ–™ä¸ç›¸å…³æˆ–ä¸è¶³ï¼Œè¯·è¯´æ˜"æ ¹æ®ç°æœ‰èµ„æ–™æ— æ³•å›ç­”æ­¤é—®é¢˜"ã€‚`

type Config struct {
	// æ•°æ®åº“ç›¸å…³
	DBUser     string
	DBPassword string
	DBHost     string
	DBPort     string
	DBName     string

	// OpenAIç›¸å…³
	OpenAIAPIKey         string
	OpenAIAPIUrl         string
	OpenAIModel          string // For chat completions
	OpenAIEmbeddingModel string // For embeddings
	// æ–°å¢ï¼šé»˜è®¤ç³»ç»Ÿæç¤ºè¯
	GenericSystemPrompt       string
	KnowledgeBaseSystemPrompt string

	// æœåŠ¡ç«¯å£
	ServerPort string
}

// NewConfig ä»ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼åˆå§‹åŒ–é…ç½®
func NewConfig() *Config {
	cfg := &Config{
		// ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
		DBUser:               getEnv("DB_USER", "root"),
		DBPassword:           getEnv("DB_PASSWORD", "YOUR_DB_PASSWORD"),
		DBHost:               getEnv("DB_HOST", "YOUR_DB_HOST"),
		DBPort:               getEnv("DB_PORT", "3306"),
		DBName:               getEnv("DB_NAME", "aiqabeta"),
		OpenAIAPIKey:         getEnv("OPENAI_API_KEYs", "YOUR_OPENAI_API_KEY"),
		OpenAIAPIUrl:         getEnv("OPENAI_API_URL", "https://api.openai.com/v1/chat/completions"), // Keep this for chat if needed
		OpenAIModel:          getEnv("OPENAI_MODEL", "chatgpt-4o-latest"),                            // Changed default model to gpt-4o
		OpenAIEmbeddingModel: getEnv("OPENAI_EMBEDDING_MODEL", "text-embedding-3-large"),             // Added embedding model, using a recommended default
		// æ·»åŠ é»˜è®¤æç¤ºè¯åŠ è½½
		GenericSystemPrompt:       getEnvOrDefault("GENERIC_SYSTEM_PROMPT", defaultGenericPrompt),
		KnowledgeBaseSystemPrompt: getEnvOrDefault("KB_SYSTEM_PROMPT", defaultKBPrompt),
		ServerPort:                getEnv("SERVER_PORT", ":8080"),
	}
	// æ‰“å°åŠ è½½çš„é…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒå¯ç§»é™¤ï¼‰
	// fmt.Printf("Config loaded: %+v\n", cfg) // æš‚æ—¶æ³¨é‡Šæ‰ï¼Œé¿å…æ‰“å°è¿‡é•¿æç¤ºè¯
	return cfg
}

// GetDBDSN è¿”å›ç”¨äºsql.Opençš„æ•°æ®åº“è¿æ¥DSN
func (c *Config) GetDBDSN() string {
	// åœ¨ DSN ä¸­æ·»åŠ  charset=utf8mb4 å‚æ•°
	return fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?parseTime=true&charset=utf8mb4",
		c.DBUser, c.DBPassword, c.DBHost, c.DBPort, c.DBName)
}

// è¾…åŠ©å‡½æ•°ï¼šè‹¥ç¯å¢ƒå˜é‡ä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
func getEnv(key, defaultVal string) string {
	if val, ok := os.LookupEnv(key); ok {
		return val
	}
	return defaultVal
}

// è¾…åŠ©å‡½æ•°ï¼šè‹¥ç¯å¢ƒå˜é‡ä¸å­˜åœ¨æˆ–ä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
func getEnvOrDefault(key, defaultVal string) string {
	if val, ok := os.LookupEnv(key); ok && val != "" {
		return val
	}
	return defaultVal
}
